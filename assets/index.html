<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WASM C Compiler & Disassembler</title>
</head>
<body>
  <h2>1. Enter C Code</h2>
  <textarea id="cInput" rows="10" cols="60">
int test(int a, int b) {
  return a + b;
}
  </textarea><br>
  <button onclick="compileToHex()">Compile to Hex</button>

  <h2>2. Compiled Hex</h2>
  <pre id="hexOutput">Waiting for compilation...</pre>
  <button onclick="runDisasm()">Disassemble Hex</button>

  <h2>3. Disassembled Output</h2>
  <pre id="output">Loading modules...</pre>

  <!-- adjust these paths if your folders differ -->
  <script src="../libs/build-wrapper/capstone.js"></script>
  <script src="../libs/build-tcc/tcc.js"></script>
  <script>
    let capstoneModule, tccModule, disasmFunc;

    async function initModules() {
      capstoneModule = await createCapstoneModule({
        print:    txt => output(txt),
        printErr: txt => output("[cap err] "+txt)
      });
      disasmFunc = capstoneModule.cwrap("disasm_x86", null, ["array","number"]);
      output("✅ Capstone loaded.");

      tccModule = await createTCC({
        locateFile: path => {
          if (path.endsWith(".wasm")||path.endsWith(".data")) 
            return "../libs/build-tcc/"+path;
          return path;
        },
        print:    txt => console.log("[tcc] "+txt),
        printErr: txt => console.error("[tcc err] "+txt)
      });
      document.getElementById("hexOutput").textContent =
        "✅ TinyCC loaded. Ready to compile.";
      console.log("TinyCC ready");
    }

    function output(txt) {
      let o = document.getElementById("output");
      o.textContent += txt+"\n";
    }

    window.compileToHex = () => {
      let code = document.getElementById("cInput").value;
      if (!tccModule) return alert("TinyCC not yet loaded");
      tccModule.FS.writeFile("input.c", code);

      let lenPtr = tccModule._malloc(4);
      let compileFn = tccModule.cwrap(
        "compile_and_get_text","number",["string","number"]
      );
      let ptr  = compileFn("input.c", lenPtr);
      let size = tccModule.HEAP32[lenPtr>>2];
      tccModule._free(lenPtr);

      if (!ptr||!size) {
        return document.getElementById("hexOutput").textContent =
          "❌ Compile failed or no .text section.";
      }

      let bytes = new Uint8Array(
        tccModule.HEAPU8.buffer, ptr, size
      );
      document.getElementById("hexOutput").textContent =
        [...bytes].map(b=>b.toString(16).padStart(2,"0")).join(" ");
      window.lastCompiledBytes = bytes;
    };

    window.runDisasm = () => {
      const buf = window.lastCompiledBytes;
      if (!disasmFunc || !buf) {
        return alert("Missing Capstone or compiled bytes");
      }
      // clear & start output
      document.getElementById("output").textContent = "Disassembling…\n";
      // Emscripten will malloc+copy automatically for you
      disasmFunc(buf, buf.length);
    };


    initModules();
  </script>
</body>
</html>
